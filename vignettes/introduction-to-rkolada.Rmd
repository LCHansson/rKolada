---
title: "Introduction to rKolada"
author: "Love Hansson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to rKolada}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction to rKolada

The Swedish Municipalities and Regions Database (Kolada) is a openly accessible database containing over 4,000 Key Performance Indicators for a vast number of aspects of municipal and regional organisations, politics and economic life. The `rKolada` R package provides an interface to R users to directly download, explore, and simplify metadata and data from Kolada. The package draws heavily on functionality provided by several packages in the `tidyverse` family and it is thus recommended that you install the `tidyverse` package before installing rKolada:

```{r, eval = FALSE}
install.packages("tidyverse")
```

This vignette provides a quick-start introduction to the core functionality of the package. To learn more about the specifics of functions and to see a full list of the functions included, please see `??rKolada`.

```{r setup}
suppressPackageStartupMessages(library("tidyverse"))
library("rKolada")
```

## Getting started with rKolada in five quick steps

### 1. Get metadata

Kolada contains five different types of metadata entities: 
1. `kpi`: Key Performance Indicators
2. `municipality`: Municipalities
3. `ou`: Operating Unit, a subunit of municipalities
4. `kpi_groups`: Thematic groupings of KPIs
5. `municipality_groups`: Thematic groupings of municipalities

To obtain data using `rKolada` it is usually a good idea to start by exploring metadata. `rKolada` comes with convenience functions for each of the five above mentioned entities. These functions are all names `[entity]_get()` and can be called as follows. The `cache` parameter allows you to temporarily store results on disk to avoid repeated calls to the API in case you need to re-run your code:

```{r}
kpis <- kpi_get(cache = TRUE)
munic <- municipality_get(cache = TRUE)
```

If you have already familiarised yourself with the Kolada API (e.g. by reading the [official docs on GitHub](https://github.com/Hypergene/kolada)) you can access the full metadata API using `get_kld_metadata()`.

### 2. Search metadata

Metadata tables are stored as regular `tibble`s so you can start inspecting them by simply viewing them in RStudio. For example, the KPI metadata we downloaded looks like this:

```{r}
dplyr::glimpse(kpis)
```

But `rKolada` also comes with a set of convenience functions to simplify the task of exploring KPI metadata. `kpi_search()` filters down a list of KPIs using a search term, and `kpi_minimize()` can be used to clean the KPI metadata table from columns that don't contain any information that distinguish KPIs from each other:

```{r}
kpi_res <- kpis %>%
  kpi_search("BRP") %>%
  kpi_minimize(remove_undocumented_columns = TRUE, remove_monotonous_data = TRUE)

dplyr::glimpse(kpi_res)
```

### 3. Describe KPIs

In addition to the information provided about every KPI in the `title` and `description` columns of a KPI table, `kpi_add_keywords()` can be used to create a rough summary of every KPI creating a number of _keyword_ columns. The function `kpi_describe()` can be used to print a huamn readable table containing a summary of a table of KPIs.

```{r, results = 'asis'}
kpi_res %>% kpi_add_keywords(n = 4) %>% kpi_describe(max_n = 5)
```

### 4. Get data

Once we have settled on what KPIs we are interested in the next step is to download actual data from Kolada. Use `get_kld_data()` to do this. To download data from the Kolada API you need to provide at least two of the following parameters:

1. `kpi`: One or a vector of several KPI IDs
2. `municipality`: One or a vector of several municipality IDs
3. `period`: The years for which data should be downloaded.

The ID tags for KPIs and municipalities can be extracted using the convenience functions `kpi_query_filter()` and `municipality_name_to_filter()`:

```{r}
kld_data <- get_kld_data(
  kpi = kpi_query_filter(kpi_res),
  municipality = municipality_name_to_filter(munic, c("Stockholm", "Göteborg", "Malmö")),
  period = 1990:2019,
  simplify = TRUE
)
```

Setting the `simplify` parameter to `TRUE`, again, makes results more human readable, by removing undocumented columns and relabeling data with human-friendly labels.


### 5. Inspect and visualise results

Finally, time to inspect our data:

```{r}
# Inspect results in an interactive table
DT::datatable(kld_data)

# Visualise results
library("ggplot2")

ggplot(kld_data, aes(x = year, y = value)) +
  geom_line(aes(color = municipality)) +
  facet_grid(kpi ~ .) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Gross Regional Product",
    subtitle = "Yearly development in Sweden's three most populous municipalities",
    x = "Year",
    y = ""
  )
```



