#' Compose a query to fetch metadata from the Kolada API. Its use is mainly
#'
#' Mainly used as a supporting function for \code{link{get_values}} but can also be
#' used to create a working URL to paste in your web browser.
#'
#' @param kpi What kpis should be fetched? Can be a single name or a vector of
#'  names.
#' @param municipality For which municipalities should data be fetched? Can be a
#' single name or a vector of names.
#' @param period For what years should data be fetched? Can be one or more
#' four-digit integers or character strings.
#' @param ou (Optional) for what Operating Units should data be fetched? Only
#' available for certain KPIs.
#' @param version Version of the API. Currently only \code{"v2"} is supported.
compose_data_query <- function(kpi = NULL, municipality = NULL, period = NULL, ou = NULL, version = "v2") {

  base_url <- glue::glue("http://api.kolada.se/{version}/data")

  if (is.null(kpi))
    kpi <- ""
  else
    kpi <- paste0("/kpi/", paste(kpi, collapse = ","))

  if (!is.null(municipality) & !is.null(ou))
    warning("RAISE MUNICIPALITY AND OU GIVEN WARNING HERE")

  if (is.null(municipality) & is.null(ou))
      municipality <- ""
  else if(!is.null(municipality))
    municipality <- paste0("/municipality/", paste(municipality, collapse = ","))
  else
    municipality <- paste0("/ou/", paste(ou, collapse = ","))

  if (is.null(period))
    period <- ""
  else
    period <- paste0("/year/", paste(period, collapse = ","))

  if (sum(stringr::str_length(c(kpi, municipality, period)) > 0) < 2)
    stop("RAISE TOO FEW PARAMETERS IN DATA QUERY ERROR HERE")

  query_url <- glue::glue("{base_url}{kpi}{municipality}{period}")

  return(utils::URLencode(query_url))
}

#' Get data from Kolada
#'
#' Download a table of data from Kolada. Data is selected based on three metadata
#' dimensions: KPI (ID), municipality (ID) and period (years). You must supply
#' arguments for at least two of these three dimensions. If a dimension is omitted,
#' all available data for that dimension will be downloaded.
#'
#' @param kpi What kpis should be fetched? Can be a single name or a vector of
#' names.
#' @param municipality For which municipalities should data be fetched? Can be a
#' single name or a vector of names.
#' @param period For what years should data be fetched? Can be one or more
#' four-digit integers or character strings.
#' @param ou (Optional) for what Operating Units should data be fetched? Only
#' available for certain KPIs.
#' @param simplify Whether to make results more human readable.
#' @param verbose Whether to print the call to the Kolada API as a message to
#' the R console.
#'
#' @return A tibble containing Kolada values and metadata.
#'
#' @examples
#' \dontrun{
#' # Download data for KPIs for Gross Regional Product ("BRP" in Swedish)
#' # for three municipalities
#' grp_kpi <- get_kpi() %>% kpi_search("BRP") %>% kpi_extract_ids()
#'
#' largest_munic <- get_municipality() %>%
#'   municipality_name_to_id(c("Stockholm", "Göteborg", "Malmö"))
#'
#' grp_data <- get_values(
#'   kpi = grp_kpi,
#'   municipality = largest_munic
#' )
#'
#' # If you already know the ID numbers you are looking for,
#' # you can use these directly as argments.
#' grp_data <- get_values(
#'   kpi = c("N03700", "N03701"),
#'   municipality = c("0180", "1480", "1280")
#')
#' }
#'
#' @export
get_values <- function(
  kpi = NULL,
  municipality = NULL,
  period = NULL,
  ou = NULL,
  simplify = TRUE,
  verbose = FALSE
) {
  query <- compose_data_query(kpi, municipality, period, ou)

  if (isTRUE(verbose))
    message("Downloading Kolada data using URL\n", query)

  res <- httr::RETRY("GET", query)

  contents_raw <- httr::content(res, as = "text")
  contents <- jsonlite::fromJSON(contents_raw)[["values"]]
  ret <- tibble::as_tibble(contents) %>%
    tidyr::unnest(cols = c(values))

  if (isTRUE(simplify)) {
    ret_has_groups <- any(stringr::str_detect(ret$municipality, "^G"))

    munic_tbl <- get_municipality(verbose = FALSE)

    if (ret_has_groups)
      munic_tbl <- munic_tbl %>%
      dplyr::bind_rows(
        get_municipality_groups() %>%
          dplyr::select(id, title) %>%
          dplyr::mutate(type = "G")
      )

    ret <- ret %>%
      # Remove "status" column (does it ever contain anything?)
      dplyr::select(-status) %>%
      # Convert codes to names
      dplyr::rename(
        municipality_id = municipality
      ) %>%
      dplyr::inner_join(
        dplyr::select(
          munic_tbl,
          municipality_id = id,
          municipality = title,
          municipality_type = type),
        by = "municipality_id"
      ) %>%
      dplyr::rename(year = period)
  }

  ret
}

#' Simplify a Kolada values table
#'
#' Simplify a Kolada values table, i.e as created by \code{\link{get_valus}}, by
#' removing columns that contain monotonous data, i.e. that contain only one value
#' for all observations.
#'
#' @param values_df A Kolada value table, as created by \code{\link{get_values}}.
#'
#' @return A Kolada values table
#'
#' @examples
#' \dontrun{
#' # Download values for a KPI for the year 2010
#' vals <- get_values(kpi = "N00002", period = 2010, simplify = TRUE) %>%
#'   dplyr::filter(municipality_type == "K")
#' # (Returns a table with 29 rows and 8 columns)
#'
#' # Remove columns with no information to differentiate between rows
#' values_minimize(vals)
#' # (Returns a table with 29 rows and 4 columns)
#' }
#' @export

values_minimize <- function(values_df) {
  values_df %>%
    dplyr::select_if(names(.) %in% c("kpi", "municipality", "value") | purrr::map(., dplyr::n_distinct) > 1)
}

#' Create KPI long-form descriptions to add to a plot
#'
#' In a Kolada values table, only KPI ID names are preserved. But in plots you
#' often want to add a legend to explain what each KPI ID represents. But since
#' KPI explanations are mostly relatively wordy, ggplot2 legends are
#' under-dimensioned for this task. \code{values_legend} returns a string which can
#' conveniently be used as caption to a plot instead.
#'
#' @param values_df A Kolada value table, as created by \code{\link{get_values}}.
#' @param kpi_df A KPI table, e.g. as created by \code{\link{get_kpi}}.
#'
#' @examples
#' \dontrun{
#' }
#'
#' @export
values_legend <- function(values_df, kpi_df, width = 60) {
  kpis <- unique(values_df$kpi)
  desc <- kpi_df %>%
    dplyr::select(id, title) %>%
    dplyr::filter(id %in% kpis)

  paste(glue::glue_data(desc, "{id}: {title}"), collapse = "\n")
}

